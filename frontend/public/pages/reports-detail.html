
<div class="container mt-4">
  <h2>Detailed Reports</h2>
<button class="btn btn-primary" onclick="customAlert('Coming Soon!')">Export to CSV</button>
  <!-- Select Type Selection-->
   <br>
   <br>
  <div class="mb-3">
    <label for="typeSelect" class="form-label">Type:</label>
    <select id="typeSelect" class="form-select" style="width: 200px; display: inline-block;">
      <option value="">Select Type</option>
      <option value="incomes">Income</option>
      <option value="sales">Sales</option>
      <option value="expenses">Expenses</option>
      <option value="summary">Summary</option>
      <option value="daily">Daily</option>
    </select>
    <!-- Date range -->
    <label for="startDate" class="form-label ms-3">Start Date:</label>
    <input type="date" id="startDate" class="form-control" style="width: 200px; display: inline-block;" />

    <label for="endDate" class="form-label ms-3">End Date:</label>
    <input type="date" id="endDate" class="form-control" style="width: 200px; display: inline-block;" />

    <button id="btnLoadReport" class="btn btn-primary" disabled>Load Report</button>
  </div>

  <!-- Exam Info Section -->
  <div id="incomeInfoSection" style="display: none;" class="mb-4">
    <h4>Report Info: <span id ="reportInfo"></span></h4>
    <p><strong>Report Type:</strong> <span id="reportType">Top 3 Income Sources</span></p>
    <p><strong>Item:</strong> <span> Income</span></p>
    <p><strong>Amount Generated:</strong> <span id="incomeTotalGenerated"></span></p>
  </div>

  <div id="summaryInfoSection" style="display: none;" class="mb-4">
    <h4>Report Info: <span id="summaryHeader"></span></h4>
    <p><strong>Report Type: Summary</strong> <span id="reportType"></span></p>
  </div>

  <div id="expensesInfoSection" style="display: none;" class="mb-4">
    <h4>Report Info: <span id="expensesHeader"></span></h4>
    <p><strong>Report Type:</strong> <span> Top 3 Expenses Sources</span></p>
    <p><strong>Item:</strong> <span>Expenses</span></p>
    <p id="incomeItem"><strong>Amount Generated:</strong> <span id="expensesBestAmount"></span></p>
  </div>

  <div id="salesInfoSection" style="display: none;" class="mb-4">
    <h4>Report Info: <span id="salesHeader"></span></h4>
    <p><strong>Report Type:</strong> <span>Best / Worst Selling Items</span></p>
    <p><strong>Best Selling Category:</strong> <span id="bestSellingCat"></span></p>
    <p><strong>Amount Generated:</strong> <span id="categoryTotalsales"></span></p>
    <p><strong>Number of Items:</strong> <span id="categorySalesCount"></span></p>
  </div>

  <!-- Summary Cards -->
  <div id="incomeSummaryCards" style="display: none;">
    <div class="row">
      <div class="col-md-3">
        <div class="card text-white bg-primary mb-3">
          <div class="card-header" id="incomeHeader0">Total Income</div>
          <div class="card-body">
            <h5 class="card-title" id="incomeHeader0Val">0</h5>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card text-white bg-success mb-3">
          <div class="card-header" id = "incomeHeader1">Total Income Quantity </div>
          <div class="card-body">
            <h5 class="card-title" id="incomeHeader1Val">0</h5>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card text-white bg-info mb-3">
          <div class="card-header" id = "incomeHeader2">Category Sales</div>
          <div class="card-body">
            <h5 class="card-title" id="incomeHeader2Val">0</h5>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card text-white bg-warning mb-3">
          <div class="card-header" id = "incomeHeader3">Total Income from Sources</div>
          <div class="card-body">
            <h5 class="card-title" id="totalIncomeSources">0</h5>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="salesSummaryCards" style="display: none;">
    <div class="row">
      <div class="col-md-3">
        <div class="card text-white bg-primary mb-3">
          <div class="card-header" id="salesHeader0">Total Sales</div>
          <div class="card-body">
            <h5 class="card-title" id="totalSales">0</h5>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card text-white bg-success mb-3">
          <div class="card-header" id="salesHeader1">Total Sales Quantity </div>
          <div class="card-body">
            <h5 class="card-title" id="totalSalesQuantity">0</h5>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card text-white bg-info mb-3">
          <div class="card-header" id="salesHeader2">Category Sales</div>
          <div class="card-body">
            <h5 class="card-title" id="categoryTotalsales">0</h5>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card text-white bg-warning mb-3">
          <div class="card-header" id="salesHeader3">Average Sales Per Day</div>
          <div class="card-body">
            <h5 class="card-title" id="averageSales">0</h5>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="expensesSummaryCards" style="display: none;">
    <div class="row">
      <div class="col-md-3">
        <div class="card text-white bg-primary mb-3">
          <div class="card-header" id="expensesHeader0">Expenses</div>
          <div class="card-body">
            <h5 class="card-title" id="expensesHeader0Val">0</h5>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card text-white bg-success mb-3">
          <div class="card-header" id="expensesHeader1">Expenses</div>
          <div class="card-body">
            <h5 class="card-title" id="expensesHeader1Val">0</h5>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card text-white bg-info mb-3">
          <div class="card-header" id="expensesHeader2">Expenses</div>
          <div class="card-body">
            <h5 class="card-title" id="expensesHeader2Val">0</h5>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card text-white bg-warning mb-3">
          <div class="card-header" id="expensesHeader3">Total Expenses from Sources</div>
          <div class="card-body">
            <h5 class="card-title" id="expensesHeader3Val">0</h5>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="summaryCards" style="display: none;">
  <div class="row">
    <div class="col-md-3">
      <div class="card text-white bg-primary mb-3">
        <div class="card-header" id="incomeHeader0">Total Sales</div>
        <div class="card-body">
          <h5 class="card-title" id="totalSummary">0</h5>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-white bg-success mb-3">
        <div class="card-header" id="incomeHeader1">Total Sales Quantity </div>
        <div class="card-body">
          <h5 class="card-title" id="totalSummaryQuantity">0</h5>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-white bg-info mb-3">
        <div class="card-header" id="incomeHeader2">Category Sales</div>
        <div class="card-body">
          <h5 class="card-title" id="reportBestAmountVal">0</h5>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-white bg-warning mb-3">
        <div class="card-header" id="incomeHeader3">Average Sales Per Day</div>
        <div class="card-body">
          <h5 class="card-title" id="reportAverageSales">0</h5>
        </div>
      </div>
    </div>
  </div>
  </div>

  <!-- Selling Items Breakdown Table -->
  <div id="salesBreakdownSection" style="display: none;">
    <h4>Best Selling Items Breakdown:</h4>
    <table class="table">
      <thead>
      <tr>
        <th>Name</th>
        <th>Amount Generated</th>
        <th>Quantity</th>
      </tr>
      </thead>
      <tbody id="salesBreakdownBody">
      <!-- filled by JS -->
      </tbody>
    </table>
  </div>

  <div id="salesBreakdownSection2" style="display: none;">
    <h4>Worst Selling Items Breakdown:</h4>
    <table class="table">
      <thead>
        <tr>
          <th>Name</th>
          <th>Amount Generated</th>
          <th>Quantity</th>
        </tr>
      </thead>
      <tbody id="salesBreakdownBody2">
        <!-- filled by JS -->
      </tbody>
    </table>
  </div>
  
  <div id="expensesBreakdownSection" style="display: none;">
    <h4>Summary of Daily Transactions</h4>
    <table class="table">
      <thead>
        <tr>
          <th>Date</th>
          <th>Income</th>
          <th>Expenses</th>
        </tr>
      </thead>
      <tbody id="breakdownTbody3">
        <!-- filled by JS -->
      </tbody>
    </table>
  </div>

  <div id="summaryBreakdownSection" style="display: none;">
    <table class="table">
      <thead>
      <tr>
        <th >Date</th>
        <th >Income</th>
        <th >Expenses</th>
      </tr>
      </thead>
      <tbody id="summarybreakdownBody">
      <!-- filled by JS -->
      </tbody>
    </table>
  </div>
<div id="reportContainer" style="display: none;"></div>
</div>

  <script>
    function naira(amount) {
  return `â‚¦${amount.toLocaleString('en-NG')}`;
    }

    function formatDateLong(dateStr) {
        const date = new Date(dateStr);
        const day = date.getDate();

        const getOrdinal = (n) => {
          if (n > 3 && n < 21) return 'th';
          switch (n % 10) {
            case 1: return 'st';
            case 2: return 'nd';
            case 3: return 'rd';
            default: return 'th';
          }
        };

        const month = date.toLocaleString('default', { month: 'long' });
        const year = date.getFullYear();

        return `${day}${getOrdinal(day)} ${month} ${year}`;
      }
  async function customAlert(message, options = {}) {
    return new Promise((resolve) => {
      const customAlert = document.getElementById('custom-alert');
      const customAlertMessage = document.getElementById('custom-alert-message');
      const customAlertOk = document.getElementById('custom-alert-ok');
      const customAlertCancel = document.getElementById('custom-alert-cancel');

      customAlertMessage.innerText = message;

      if (options.confirm) {
        customAlertCancel.style.display = 'inline-block';
      } else {
        customAlertCancel.style.display = 'none';
      }

      customAlert.style.display = 'block';
      setTimeout(() => {
        customAlert.classList.add('show');
      }, 10);

      customAlertOk.addEventListener('click', () => {
        customAlert.classList.remove('show');
        setTimeout(() => {
          customAlert.style.display = 'none';
          resolve(true);
        }, 500);
      });

      customAlertCancel.addEventListener('click', () => {
        customAlert.classList.remove('show');
        setTimeout(() => {
          customAlert.style.display = 'none';
          resolve(false);
        }, 500);
      });
    });
  }


    const select = document.getElementById('typeSelect');
      const button = document.getElementById('btnLoadReport');

      select.addEventListener('change', () => {
        if (select.value !== '') {
          button.disabled = false;
        } else {
          button.disabled = true;
        }
      });

    function loadReportPage() {
     // 2) On "Load Report" => call getDetailedReport()
      document.getElementById("btnLoadReport").addEventListener("click", function() {
        // clearExistingData();
        getDetailedReport();
        button.disabled = true;
      });
    }


    function hideDashboardSections() {
        const elementIds = [

          "expensesSummaryCards",
          "expensesInfoSection",
          "salesInfoSection",
          "salesBreakdownSection",
          "salesBreakdownSection2",
          "salesSummaryCards",
          "incomeSummaryCards",
          "incomeInfoSection",
          "summaryBreakdownSection",
          "reportContainer",
          "summaryInfoSection"
        ];

        elementIds.forEach(id => {
          const el = document.getElementById(id);
          if (el) el.style.display = "none";
        });

        // Remove elements with class "myRow" using jQuery
        if ($('.myRow').length) {
          $('.myRow').remove();
        }
      }

      // Call the function
  function displayReport(data) {
    hideDashboardSections()
    console.log(data)
    const container = document.getElementById('reportContainer');
    container.style.display='block';
    (data.dailyReport.forEach((day) => {
      const reportEl = document.createElement('div');
      reportEl.className = 'day-report';

      reportEl.innerHTML = `
          <h2>Date: ${formatDateLong(day.date)}</h2>
          <h3>Incomes</h3>
          <table>
            <tr><th>Description</th><th>Amount</th></tr>
            ${day.incomes.map(item => `
              <tr>
                <td>${item.description}</td>
                <td>â‚¦${item.amount}</td>
              </tr>`).join('')}
          </table>

          <h3>Expenses</h3>
          <table>
            <tr><th>Description</th><th>Amount</th></tr>
            ${day.expenses.map(item => `
              <tr>
                <td>${item.description}</td>
                <td>â‚¦${item.amount}</td>
              </tr>`).join('')}
          </table>

          <div class="totals">
            Total Income: â‚¦${day.totalIncome} <br>
            Total Expense: â‚¦${day.totalExpense} <br>
            Net Total: <span class="${day.netTotal >= 0 ? 'net-positive' : 'net-negative'}">
              â‚¦${day.netTotal}
            </span>
          </div>
        `;
      container.appendChild(reportEl);
    }));
  }

    async function getDetailedReport() {
      const startDate = document.getElementById("startDate").value;
      const endDate = document.getElementById("endDate").value;
      const type = document.getElementById("typeSelect").value;
      if (!startDate || !endDate ) {
        customAlert("Please select a date range.");
        return;
      }

      let endpoint = API_URL + "reports/" + `${type}` + `/?startDate=${startDate}&endDate=${endDate}`;
      if(!type) {
        customAlert("Please select a valid type.");
        return;
      }
          if (type === "sales") {
            try {
              const res = await fetch(endpoint, {
        method: "GET", 
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${localStorage.getItem("token")}`  
        }
            });
            const data = await res.json();
          // If no participants or error
          if (data.error) {
            customAlert(data.error);
            return;
          }

            //remove elements from other reports
             hideDashboardSections()
          // Show result details
          document.getElementById("salesInfoSection").style.display = "block";
           document.getElementById("salesHeader").textContent = `From ${formatDateLong(startDate)} to ${formatDateLong(endDate)}`;
          document.getElementById("bestSellingCat").textContent = data.bestSellingCategory;
          document.getElementById("categoryTotalsales").textContent = naira(data.categoryTotalsales);
          document.getElementById("categorySalesCount").textContent = data.categorySalesCount;
          //get average sales per day
          const totalDays = Math.ceil((new Date(endDate) - new Date(startDate)) / (1000 * 60 * 60 * 24)) + 1;
          const averageSales = data.totalSales.total / totalDays;

          
            // Show Cards
          document.getElementById("salesSummaryCards").style.display = "block";
          document.getElementById("totalSales").textContent = naira(data.totalSales.total) || naira(0);
          document.getElementById("totalSalesQuantity").textContent = data.totalSales.quantity || 0;
          document.getElementById("categoryTotalsales").textContent = naira(data.categoryTotalsales) || naira(0);
          document.getElementById("averageSales").textContent = naira(averageSales);


          document.getElementById("salesBreakdownSection").style.display = "block";
          const breakdownBody = document.getElementById("salesBreakdownBody");
          (data.best || []).forEach(d => {
            let row = document.createElement("tr");
            row.setAttribute("class", "myRow");
            let tdName = document.createElement("td");
            tdName.textContent = d._id;
            let tdCount = document.createElement("td");
            tdCount.textContent = naira(d.totalAmount);
            let tdQty = document.createElement("td");
            tdQty.textContent = d.count;
            row.appendChild(tdName);
            row.appendChild(tdCount);
            row.appendChild(tdQty);
            breakdownBody.appendChild(row);
          });
          document.getElementById("salesBreakdownSection2").style.display = "block";
          const breakdownBody2 = document.getElementById("salesBreakdownBody2");
          (data.worst || []).forEach(d => {
            let row2 = document.createElement("tr");
            row2.setAttribute("class", "myRow");
            let tdName2 = document.createElement("td");
            tdName2.textContent = d._id;
            let tdCount2 = document.createElement("td");
            tdCount2.textContent = naira(d.totalAmount);
            let tdQty = document.createElement("td");
            tdQty.textContent = d.count;
            row2.appendChild(tdName2);
            row2.appendChild(tdCount2);
            row2.appendChild(tdQty);
            breakdownBody2.appendChild(row2);
          });
         
          }
          catch (err) {
            console.log(err);
            customAlert("Failed to load report.");
          }
        }
        else if (type === "incomes") {
          try {
            const res = await fetch(endpoint, {
              method: "GET",
              headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${localStorage.getItem("token")}`
              }
            });
            const data = await res.json()
            if (data.error) {
              customAlert(data.error);
              return;
            }
            const totalAmount = (data[0]? data[0].totalIncome : 0) + 
            (data[1]? data[1]?.totalIncome : 0) + (data[2]? data[2].totalIncome : 0);

            //remove elements from other reports
            hideDashboardSections()
            

            //display current elements
            document.getElementById("incomeInfoSection").style.display = "block";
            document.getElementById("reportInfo").textContent = `From ${formatDateLong(startDate)} to ${formatDateLong(endDate)}`;
            document.getElementById("incomeTotalGenerated").textContent = naira(totalAmount) || naira(0);
            document.getElementById("incomeSummaryCards").style.display = "block";
            document.getElementById("incomeHeader0").textContent = data[0]?._id || "Not Yet Available";
            document.getElementById("incomeHeader1").textContent = data[1]?._id || "Not Yet Available";
            document.getElementById("incomeHeader2").textContent = data[2]?._id || "Not Yet Available";
            document.getElementById("incomeHeader0Val").textContent = data[0]? naira(data[0].totalIncome) : naira(0);
            document.getElementById("incomeHeader1Val").textContent = data[1]? naira(data[1].totalIncome) : naira(0);
            document.getElementById("incomeHeader2Val").textContent = data[2]? naira(data[2].totalIncome) : naira(0);
            document.getElementById("totalIncomeSources").textContent = naira(totalAmount) || naira(0);
          }
          catch (error) {
            customAlert(error)
            return
          }
        }
        else if (type === "expenses") {

          try {
                const res = await fetch(endpoint, {
              method: "GET",
              headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${localStorage.getItem("token")}`
              }
            });
            const data = await res.json()
            console.log(data)
            if(data.error) {
              customAlert(data.error)
              return
            }
             //remove elements from other reports
            hideDashboardSections()
            const totalAmount = (data[0] ? data[0].totalExpenses : 0) +
              (data[1] ? data[1]?.totalExpenses : 0) + (data[2] ? data[2].totalExpenses : 0);
            document.getElementById("expensesInfoSection").style.display = "block";
             document.getElementById("expensesHeader").textContent = `From ${formatDateLong(startDate)} to ${formatDateLong(endDate)}`;
            document.getElementById("reportBestAmount").textContent = naira(totalAmount) || 0;
            document.getElementById("reportBestCountItem").style.display = "none";
            document.getElementById("expensesSummaryCards").style.display = "block";
            document.getElementById("expensesHeader0").textContent = data[0] ? data[0]._id : "Not Available"
            document.getElementById("expensesHeader1").textContent = data[1] ? data[1]._id : "Not Available"
            document.getElementById("expensesHeader2").textContent = data[2] ? data[2]._id : "Not Available"
            document.getElementById("expensesHeader0Val").textContent = data[0] ? naira(data[0].totalExpenses) : naira(0)
            document.getElementById("expensesHeader1Val").textContent = data[1] ? naira(data[1].totalExpenses) : naira(0)
            document.getElementById("expensesHeader2Val").textContent = data[2] ? naira(data[2].totalExpenses) : naira(0)
            document.getElementById("expensesHeader3Val").textContent = naira(totalAmount) || 0;
          }
          catch(error) {
              customAlert(error);
              return
          }
        }
        else if(type === "summary") {
          try {
            const res = await fetch(endpoint, {
              method: "GET",
              headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${localStorage.getItem("token")}`
              }
            });
            const data = await res.json();
            if (data.error) {
              customAlert(data.error);
              return;
            }
            //remove elements from other reports
            hideDashboardSections()

            document.getElementById("summaryBreakdownSection").style.display = "block";
            document.getElementById("summaryInfoSection").style.display = "block";
             document.getElementById("summaryHeader").textContent = `From ${formatDateLong(startDate)} to ${formatDateLong(endDate)}`;
            const breakdownBody = document.getElementById("summarybreakdownBody");
            (data|| []).forEach(d => {
              let row = document.createElement("tr");
              row.setAttribute('class', 'myRow')
              let tdName = document.createElement("td");
              tdName.textContent = formatDateLong(d.date);
              let tdCount = document.createElement("td");
              tdCount.textContent = naira(d.income);
              let tdQty = document.createElement("td");
              tdQty.textContent = naira(d.expense);
              row.appendChild(tdName);
              row.appendChild(tdCount);
              row.appendChild(tdQty);
              breakdownBody.appendChild(row);
            });
          }
          catch(error) {
            customAlert(error)
            return
          }
        }
        else if(type === "daily") {
          try {
            const res = await fetch(endpoint, {
              method: "GET",
              headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${localStorage.getItem("token")}`
              }
            });
            const data = await res.json()
            if (data.error) {
              customAlert(data.error);
              return;
            }
            
            displayReport(data);
            return
          }
          catch (error) {
            customAlert(error);
            return
          }

        }
        }
       
  </script>
<script>
    /* Re-init DataTable after dynamic load if needed */
    setTimeout(loadReportPage(), 100);
</script>
  
